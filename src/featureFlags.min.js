/*! PageUp's Angular Feature Flags v1.6.6 © 2021 Michael Taranto */
/*!
 * PageUp's Angular Feature Flags v1.6.6
 *
 * © 2021, Michael Taranto
 */

(function () {
  var app = angular.module("feature-flags", []);

  app.controller("MainCtrl", [
    "$scope",
    "flagServerValues",
    function ($scope, flagServerValues) {
      debugger;
      console.log("In MainCtrl");
      $scope.name = flagServerValues[0].name;
    },
  ]);

  angular.module("feature-flags").directive("featureFlag", [
    "featureFlags",
    "$interpolate",
    function (featureFlags, $interpolate) {
      return {
        transclude: "element",
        priority: 599,
        terminal: true,
        restrict: "A",
        $$tlb: true,
        compile: function featureFlagCompile(tElement, tAttrs) {
          var hasHideAttribute = "featureFlagHide" in tAttrs;

          tElement[0].textContent =
            " featureFlag: " +
            tAttrs.featureFlag +
            " is " +
            (hasHideAttribute ? "on" : "off") +
            " ";

          return function featureFlagPostLink(
            $scope,
            element,
            attrs,
            ctrl,
            $transclude
          ) {
            var featureEl, childScope;
            $scope.$watch(
              function featureFlagWatcher() {
                var featureFlag = $interpolate(attrs.featureFlag)($scope);
                return featureFlags.isOn(featureFlag);
              },
              function featureFlagChanged(isEnabled) {
                var showElement = hasHideAttribute ? !isEnabled : isEnabled;

                if (showElement) {
                  childScope = $scope.$new();
                  $transclude(childScope, function (clone) {
                    featureEl = clone;
                    element.after(featureEl).remove();
                  });
                } else {
                  if (childScope) {
                    childScope.$destroy();
                    childScope = null;
                  }
                  if (featureEl) {
                    featureEl.after(element).remove();
                    featureEl = null;
                  }
                }
              }
            );
          };
        },
      };
    },
  ]);

  angular.module("feature-flags").directive("featureFlagOverrides", [
    "featureFlags",
    function (featureFlags) {
      return {
        restrict: "A",
        link: function postLink($scope) {
          $scope.flags = featureFlags.get();

          $scope.isOn = featureFlags.isOn;
          $scope.isOverridden = featureFlags.isOverridden;
          $scope.enable = featureFlags.enable;
          $scope.disable = featureFlags.disable;
          $scope.reset = featureFlags.reset;
          $scope.isOnByDefault = featureFlags.isOnByDefault;
        },
        template:
          '<div class="feature-flags">' +
          '  <h2 class="feature-flags-heading">Feature Flags</h2>' +
          '  <div id="feature-flag--{{flag.name}}" class="feature-flags-flag" ng-repeat="flag in flags">' +
          '    <div class="feature-flags-name">{{flag.name || flag.name}}</div>' +
          '      <div id="feature-flag--{{flag.name}}--enable" class="feature-flags-switch" ng-click="enable(flag.name)" ng-class="{\'active\': isOverridden(flag.name) && isOn(flag.name)}">ON</div>' +
          '      <div id="feature-flag--{{flag.name}}--disable" class="feature-flags-switch" ng-click="disable(flag.name)" ng-class="{\'active\': isOverridden(flag.name) && !isOn(flag.name)}">OFF</div>' +
          '      <div id="feature-flag--{{flag.name}}--reset" class="feature-flags-switch" ng-click="reset(flag.name)" ng-class="{\'active\': !isOverridden(flag.name)}">DEFAULT ({{isOnByDefault(flag.name) ? \'ON\' : \'OFF\'}})</div>' +
          '    <div class="feature-flags-desc">{{flag.description}}</div>' +
          "  </div>" +
          "</div>",
        replace: true,
      };
    },
  ]);

  angular.module("feature-flags").service("featureFlagOverrides", [
    "$rootElement",
    function ($rootElement) {
      var appName = $rootElement.attr("ng-app"),
        environment = "",
        keyPrefix = "featureFlags." + appName + ".",
        localStorageAvailable = (function () {
          try {
            localStorage.setItem("featureFlags.availableTest", "test");
            localStorage.removeItem("featureFlags.availableTest");
            return true;
          } catch (e) {
            return false;
          }
        })(),
        prefixedKeyFor = function (flagName) {
          return keyPrefix + flagName;
        },
        isPrefixedKey = function (name) {
          return name.indexOf(keyPrefix) === 0;
        },
        getPrefix = function () {
          return (
            "featureFlags." + appName + "." + (environment && environment + ".")
          );
        },
        setEnvironment = function (value) {
          environment = value;
          keyPrefix = getPrefix();
        },
        setAppName = function ($appName) {
          appName = $appName;
          keyPrefix = getPrefix();
        },
        set = function (value, flagName) {
          if (localStorageAvailable) {
            localStorage.setItem(prefixedKeyFor(flagName), value);
          }
        },
        get = function (flagName) {
          if (localStorageAvailable) {
            return localStorage.getItem(prefixedKeyFor(flagName));
          }
          return null;
        },
        remove = function (flagName) {
          if (localStorageAvailable) {
            localStorage.removeItem(prefixedKeyFor(flagName));
          }
        };

      return {
        isPresent: function (name) {
          var value = get(name);
          return typeof value !== "undefined" && value !== null;
        },
        setEnvironment: setEnvironment,
        setAppName: setAppName,
        get: get,
        set: function (flag, value) {
          if (angular.isObject(flag)) {
            angular.forEach(flag, set);
          } else {
            set(value, flag);
          }
        },
        remove: remove,
        reset: function () {
          var name;
          if (localStorageAvailable) {
            for (name in localStorage) {
              if (isPrefixedKey(name)) {
                localStorage.removeItem(name);
              }
            }
          }
        },
      };
    },
  ]);

  function logIt(source, key, value, note) {
    console.log(
      "source: " +
        source +
        "; key: " +
        key +
        "... value: " +
        value +
        "; note: " +
        note
    );
  }

  function FeatureFlags($q, featureFlagOverrides, initialFlags, envParam) {
    var serverFlagCache = {},
      test = 1,
      flags = [],
      environment = "prod"; //todo: forcing prod envParam,
    (tenantName = "IN"),
      (localStoragePrefix = tenantName + ".hrc.ff." + "."),
      (instance = 0),
      (resolve = function (val) {
        var deferred = $q.defer();
        deferred.resolve(val);
        logIt("resolve", "val", val);
        return deferred.promise;
      }),
      (getCachedFlag = function (name) {
        var cacheValue =
          serverFlagCache[environment] && serverFlagCache[environment][name];
        logIt(
          "getCachedFlag",
          "cacheValue",
          cacheValue,
          ". Env = " + environment
        );
        return cacheValue;
      }),
      (isOverridden = function (name) {
        var isOver = featureFlagOverrides.isPresent(name);
        logIt("isOverriden", "has override", isOver);
        return isOver;
      }),
      (isOn = function (name) {
        var isOnTmp = isOverridden(name)
          ? featureFlagOverrides.get(name) === "true"
          : getCachedFlag(name);
        logIt("isOn", "isOnTmp", isOnTmp);
        return isOnTmp;
      }),
      (isOnByDefault = function (name) {
        isDef = getCachedFlag(name);
        logIt("isOnByDefault", "isOnByDefault", isOnByDefault);
        return isDef;
      }),
      (isEnabledForInstance = function (instances) {
        if (!instances) {
          logIt(
            "isEnabledForInstance",
            "instances",
            "true",
            " (instances is falsey)"
          );
          return true;
        }
        var isFound = instances.indexOf(instance) !== -1;
        logIt(
          "isEnabledForInstance",
          "instance found",
          isFound,
          " (instances is truthy)"
        );
        return isFound;
      }),
      (isExpired = function (expiryDate) {
        logIt("isExpired", "isExpired", "not using expiry dates");
        return false; // we are not using expiry dates
        var now = new Date().toISOString();
        if (!expiryDate) {
          logIt("isExpired", "isExpired", "no expiry date");
          return false;
        }
        var isExp = now > expiryDate;
        logIt("isExpired", "isExp", isExp, expiryDate);
        return isExp;
      }),
      (isDefaultEnabled = function (environmentEnabled, flag) {
        var isEnabled =
          environmentEnabled &&
          isEnabledForInstance(flag.instances) &&
          !isExpired(flag.expires);
        logIt("isDefaultEnabled", "isDefaultEnabled", isEnabled);
        return isEnabled;
      }),
      (updateFlagsAndGetAll = function (newFlags) {
        angular.copy(newFlags, flags);
        flags.forEach(function (flag) {
          flag.environments = { prod: true }; //forcing prod environment

          angular.forEach(
            flag.environments,
            function (environmentEnabled, env) {
              if (!serverFlagCache[env]) {
                serverFlagCache[env] = {};
              }
              serverFlagCache[env][flag.name] = isDefaultEnabled(
                environmentEnabled,
                flag
              );
              flag.environments[env] = isOn(flag.name);
            }
          );
        });
        logIt("updateFlagsAndGetAll", "flags", newFlags);
        return flags;
      }),
      (updateFlagsWithPromise = function (promise) {
        logIt("updateFlagsWithPromise", "promise", promise);
        return promise.then(function (value) {
          return updateFlagsAndGetAll(value.data || value);
        });
      }),
      (get = function () {
        logIt("get", "flags", flags);
        return flags;
      }),
      (set = function (newFlags) {
        var isArray = angular.isArray(newFlags);
        logIt("set", "isArray", isArray, " values: " + newFlags);

        return angular.isArray(newFlags)
          ? resolve(updateFlagsAndGetAll(newFlags))
          : updateFlagsWithPromise(newFlags);
      }),
      (setEnvironment = function (value) {
        logIt("setEnvironment", "value", value);
        environment = value;
        featureFlagOverrides.setEnvironment(value);
      }),
      (setAppName = function (value) {
        logIt("setAppName", "value", value);
        featureFlagOverrides.setAppName(value);
      }),
      (setInstance = function (value) {
        logIt("setInstance", "value", value);
        instance = value;
      }),
      (enable = function (flag) {
        logIt("enable", "flag", flag);
        featureFlagOverrides.set(flag, true);
      }),
      (disable = function (flag) {
        logIt("disable", "flag", flag);
        featureFlagOverrides.set(flag, false);
      }),
      (reset = function (flag) {
        logIt("reset", "flag", flag);
        featureFlagOverrides.remove(flag);
      }),
      (localStorageAvailable = function () {
        try {
          localStorage.setItem("featureFlags.availableTest", "test");
          localStorage.removeItem("featureFlags.availableTest");
          return true;
        } catch (e) {
          return false;
        }
      }),
      (prefixedLocalStorageKeyFor = function (flagName) {
        var fullName = localStoragePrefix + flagName;
        logIt("prefixedLocalStorageKeyFor", "flagName", fullName);
        return fullName;
      }),
      (setLocal = function (value, flagName) {
        var isLocalAvailable = localStorageAvailable;
        logIt(
          "setLocal",
          "flagName",
          value,
          "Local available = " + isLocalAvailable
        );
        if (isLocalAvailable) {
          localStorage.setItem(prefixedLocalStorageKeyFor(flagName), value);
        }
      }),
      (getLocal = function (flagName) {
        var value = null;

        if (localStorageAvailable) {
          value = localStorage.getItem(prefixedLocalStorageKeyFor(flagName));
        }
        logIt(
          "getLocal",
          "flagName",
          value,
          "Local available = " + isLocalAvailable
        );
        return value;
      }),
      (removeLocal = function (flagName) {
        logIt(
          "removeLocal",
          "flagName",
          "",
          "Local available = " + isLocalAvailable
        );
        if (localStorageAvailable) {
          localStorage.removeItem(prefixedKeyFor(flagName));
        }
      }),
      //rrc - changed to allow inital load from constant
      (init = function () {
        logIt("init", "initialFlags", initialFlags);
        if (initialFlags) {
          set(initialFlags);
        }
      });

    init();

    //todo: tidy this up
    return {
      set: set,
      get: get,
      //enable: enable,
      //disable: disable,
      //reset: reset,
      isOn: isOn,
      //isOnByDefault: isOnByDefault,
      //isOverridden: isOverridden,
      setEnvironment: setEnvironment,
      //setAppName: setAppName,
      //setInstance: setInstance,
      localStorageAvailable: localStorageAvailable, //todo implement local?
      setLocal: setLocal,
      getLocal: getLocal,
      removeLocal: removeLocal,
    };
  }

  angular
    .module("feature-flags") //todo: the code below is called first after the bootstrap
    //the module gets loaded, then the debugger does a lot of hidden steps then this.$get is called.
    .provider("featureFlags", function () {
      if (false) debugger;
      var initialFlags = [];
      var environment = "prod";
      var appName = "";

      this.setInitialFlags = function (flags) {
        initialFlags = flags;
      };

      this.setEnvironment = function (env) {
        environment = env;
      };

      this.setAppName = function ($appName) {
        appName = $appName;
      };

      //note: flagServerValues are being injected here
      this.$get = [
        "$q",
        "featureFlagOverrides",
        "flagServerValues",
        function ($q, featureFlagOverrides, flagServerValues) {
          //todo: are values being injected here?
          debugger;
          var initValues = flagServerValues || featureFlagOverrides;
          var service = new FeatureFlags(
            $q,
            featureFlagOverrides,
            initValues,
            environment
          );
          if (environment) {
            service.setEnvironment(environment);
          }
          if (appName) {
            service.setAppName(appName);
          }
          return service;
        },
      ];
    });
})();
